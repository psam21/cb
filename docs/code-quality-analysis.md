# Code Quality Analysis: Duplication & SOA Violations

| Priority | ID | Type | Location | Lines | Issue | Fix | Status |
|----------|----|----|----------|-------|-------|-----|--------|
| **P0** | DUP-001 | Duplication | `src/hooks/useNostrSigner.ts` | 36-64, 106-141 | Nsec signer creation duplicated in `getSigner()` and `initializeSigner()`. Identical: nip19.decode, nip44 setup, finalizeEvent, getPublicKey | Create `src/utils/signerFactory.ts` with `createNsecSigner(nsec: string): Promise<NostrSigner>`. Import in useNostrSigner. Replace both occurrences with `await createNsecSigner(nsec)` | âœ… DONE (2025-10-12): Created signerFactory.ts, refactored both locations. NIP-44 support preserved. Build passes. |
| **P0** | MIN-001 | Comment | `src/services/business/AuthBusinessService.ts` | 60, 75, 290, 337, 378 | Comments say "in-memory only, never persisted" but nsec IS now persisted | Update all 5 comments to: "Stored in Zustand and persisted to localStorage" | âœ… DONE (2025-10-12): All 5 comments updated. Lines 60, 75, 290, 337, 378 now reflect localStorage persistence. |
| **P1** | SOA-001 | SOA Violation | `src/services/business/AuthBusinessService.ts` | 76, 268, 297, 379, 393, 431 | Business layer accessing presentation state via `useAuthStore.getState()` | Change method signatures to accept `nsec: string` parameter. Remove all `useAuthStore.getState()` calls. Callers (hooks) pass nsec explicitly | âœ… DONE (2025-10-12): Removed useAuthStore import and all 6 getState() calls. Updated 5 method signatures. Removed unused clearNsec(). Hooks now pass nsec explicitly. Service has zero presentation dependencies. Net: -55 lines. |
| **P1** | SOA-002 | SOA Violation | `src/hooks/useNostrSignIn.ts` | 66-78, 128-140 | Business logic (message cache init, routing) in presentation layer | Extract to `AuthBusinessService.completeSignIn(user: UserProfile): Promise<void>`. Move cache initialization logic there. Hook calls service method, then handles navigation | âœ… DONE (2025-10-12): Created completeSignIn(pubkey) method in AuthBusinessService. Extracted message cache init logic (duplicate in both signIn methods). Hook now calls service method. Net: -24 duplicate lines. |
| **P2** | DUP-002 | Duplication | `src/hooks/useNostrSignIn.ts` | 66-78, 128-140 | Message cache initialization duplicated after extension/nsec sign-in. Identical try/catch, dynamic import, logging | **Dependency: SOA-002 must be done first**. Extract to `MessagingBusinessService.initializeCacheForUser(pubkey: string): Promise<void>`. Called from AuthBusinessService.completeSignIn | âœ… DONE (2025-10-12): Resolved by SOA-002. completeSignIn() now handles cache init, eliminating duplication. |
| **P2** | SOA-003 | SOA Violation | `src/services/business/AuthBusinessService.ts` | 310-330 | Service creates NostrSigner instances (presentation concern) | Remove signer creation from service. Methods should accept `signer: NostrSigner` parameter. Hooks create signers and pass them in | âœ… DONE (2025-10-12): Updated 4 methods to accept signer parameter (uploadAvatar, publishProfile, publishWelcomeNote, signInWithNsec). Removed createSignerFromNsec() method. Hooks now create signers using createNsecSigner and pass them in. Net: -10 lines, zero signer creation in service. |
| **P2** | MIN-002 | Optimization | `src/hooks/useNostrSigner.ts` | 36-64, 106-141 | Signer object created twice without memoization | **Dependency: DUP-001 must be done first**. After extracting createNsecSigner, use `useMemo(() => createNsecSigner(nsec), [nsec])` in useEffect | âœ… DONE (2025-10-12): Implemented useMemo to cache signer creation. Signer only recreated when nsec changes. Both getSigner() and initializeSigner() use memoized signer. Prevents recreation on every render. |
| **P3** | DUP-004 | Duplication | `src/hooks/useProductEditing.ts`, `src/hooks/useHeritageEditing.ts` | 45-75, 35-70 | Editing hook pattern duplicated. Identical: signer validation, user.pubkey check, setUpdating, error handling | Create `src/hooks/useContentEditing.ts` with generic `useContentEditing<T, TData>(updateFn: UpdateFunction)`. Refactor both hooks to use it | ðŸ”² TODO |
| **P3** | DUP-005 | Duplication | `src/hooks/useShopPublishing.ts`, `src/hooks/useHeritagePublishing.ts` | Full files | Publishing hook pattern duplicated. Overlap: validation, signer checks, progress tracking | Create `src/hooks/useContentPublishing.ts` with generic `useContentPublishing<T, TData>(publishFn: PublishFunction)`. Refactor both hooks to use it | ðŸ”² TODO |
| **P3** | SOA-004 | SOA Violation | `src/services/business/MediaBusinessService.ts` | 52 | Stateful singleton: `private lifecycleEvents: AttachmentLifecycleEvent[] = []` | Remove state from service. Return events from methods. Let hooks/components manage state with useState | ðŸ”² TODO |
| **P4** | ARCH-002 | Architecture | `src/services/business/ShopContentService.ts`, `src/services/business/HeritageContentService.ts` | 144, 531 | Both implement `ContentDetailProvider`. Duplicated registration setup | Create `src/services/business/BaseContentProvider.ts` abstract class. Both services extend it | ðŸ”² TODO |
| **P4** | SOA-005 | SOA Violation | `src/hooks/useNostrSignIn.ts` | 92-94, 154-156 | Navigation logic `router.push('/')` in hook | Return `{ success: boolean }` from signIn methods. Component handles navigation based on result | ðŸ”² TODO |
| **P5** | ARCH-001 | Documentation | `src/services/generic/GenericMediaService.ts`, `src/services/business/MediaBusinessService.ts` | N/A | Two services handle attachments. Unclear boundaries | Add JSDoc: GenericMediaService = storage/validation. MediaBusinessService = business rules/orchestration | ðŸ”² TODO |
| **P5** | DUP-003 | Duplication | `src/hooks/useAttachmentManager.ts`, `src/hooks/useSelectiveAttachmentManager.ts`, `src/hooks/useMultipleAttachments.ts` | 987, 503, 270 lines | Three overlapping attachment implementations. SelectiveAttachmentManager wraps + re-implements useAttachmentManager | Document when to use each OR consolidate into single configurable hook with mode parameter | ðŸ”² TODO |
| **P5** | ARCH-003 | Documentation | `src/services/generic/GenericRelayService.ts`, `src/services/nostr/NostrEventService.ts` | N/A | GenericRelayService (singleton) + NostrEventService (delegates). State consistency risk | Add JSDoc explaining delegation pattern. NostrEventService is facade, GenericRelayService is implementation | ðŸ”² TODO |
| **P5** | ARCH-004 | Documentation | `src/hooks/useGenericAttachmentWorkflow.ts`, `src/hooks/useMultiAttachmentWorkflow.ts` | N/A | Similar state management. Unclear when to use which | Add JSDoc explaining: useGenericAttachmentWorkflow = single content type. useMultiAttachmentWorkflow = multiple types in one form | ðŸ”² TODO |
| **P5** | MIN-003 | Consistency | Multiple hooks | N/A | Inconsistent error handling (Error objects vs strings) | Standardize on AppError throughout. Search/replace string errors with `new AppError(...)` | ðŸ”² TODO |
