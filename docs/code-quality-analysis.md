# Code Quality Analysis: Duplication & SOA Violations

| Priority | ID | Type | Location | Lines | Issue | Fix | Status |
|----------|----|----|----------|-------|-------|-----|--------|
| **P0** | DUP-001 | Duplication | `src/hooks/useNostrSigner.ts` | 36-64, 106-141 | Nsec signer creation duplicated in `getSigner()` and `initializeSigner()`. Identical: nip19.decode, nip44 setup, finalizeEvent, getPublicKey | Create `src/utils/signerFactory.ts` with `createNsecSigner(nsec: string): Promise<NostrSigner>`. Import in useNostrSigner. Replace both occurrences with `await createNsecSigner(nsec)` | âœ… DONE: Created signerFactory.ts (36 lines), refactored both locations. NIP-44 preserved. -60 lines. Commit: c38f506 |
| **P0** | MIN-001 | Comment | `src/services/business/AuthBusinessService.ts` | 60, 75, 290, 337, 378 | Comments say "in-memory only, never persisted" but nsec IS now persisted | Update all 5 comments to: "Stored in Zustand and persisted to localStorage" | âœ… DONE: Updated 5 comments to reflect localStorage persistence. Commit: c38f506 |
| **P1** | SOA-001 | SOA Violation | `src/services/business/AuthBusinessService.ts` | 76, 268, 297, 379, 393, 431 | Business layer accessing presentation state via `useAuthStore.getState()` | Change method signatures to accept `nsec: string` parameter. Remove all `useAuthStore.getState()` calls. Callers (hooks) pass nsec explicitly | âœ… DONE: Removed useAuthStore import, 6 getState() calls, clearNsec() method. Updated 5 method signatures. Service has zero presentation deps. -55 lines. Commits: c171278, 09f91fc |
| **P1** | SOA-002 | SOA Violation | `src/hooks/useNostrSignIn.ts` | 66-78, 128-140 | Business logic (message cache init, routing) in presentation layer | Extract to `AuthBusinessService.completeSignIn(user: UserProfile): Promise<void>`. Move cache initialization logic there. Hook calls service method, then handles navigation | âœ… DONE: Created completeSignIn(pubkey) in AuthBusinessService. Extracted message cache init from both signIn methods. -24 lines. Commit: aa27d7a |
| **P2** | DUP-002 | Duplication | `src/hooks/useNostrSignIn.ts` | 66-78, 128-140 | Message cache initialization duplicated after extension/nsec sign-in. Identical try/catch, dynamic import, logging | **Dependency: SOA-002 must be done first**. Extract to `MessagingBusinessService.initializeCacheForUser(pubkey: string): Promise<void>`. Called from AuthBusinessService.completeSignIn | âœ… DONE: Resolved by SOA-002. Commit: aa27d7a |
| **P2** | SOA-003 | SOA Violation | `src/services/business/AuthBusinessService.ts` | 310-330 | Service creates NostrSigner instances (presentation concern) | Remove signer creation from service. Methods should accept `signer: NostrSigner` parameter. Hooks create signers and pass them in | âœ… DONE: Updated 4 methods to accept signer param. Removed createSignerFromNsec(). Hooks create signers via createNsecSigner. Service has zero signer creation logic. -10 lines. Commit: 7220065 |
| **P2** | MIN-002 | Optimization | `src/hooks/useNostrSigner.ts` | 36-64, 106-141 | Signer object created twice without memoization | **Dependency: DUP-001 must be done first**. After extracting createNsecSigner, use `useMemo(() => createNsecSigner(nsec), [nsec])` in useEffect | âœ… DONE: Implemented useMemo with [nsec] dependency. Signer cached, only recreates when nsec changes. getSigner() and initializeSigner() use memoized signer. Commit: f81d8a7 |
| **P3** | DUP-004 | Duplication | `src/hooks/useProductEditing.ts`, `src/hooks/useHeritageEditing.ts` | 45-75, 35-70 | Editing hook pattern duplicated. Identical: signer validation, user.pubkey check, setUpdating, error handling | Create `src/hooks/useContentEditing.ts` with generic `useContentEditing<T, TData>(updateFn: UpdateFunction)`. Refactor both hooks to use it | âœ… DONE: Created useContentEditing.ts (190 lines) with 3 generic params. Refactored both hooks: Heritage (145â†’50, -95), Product (260â†’110, -150). Extracted validation, state, error handling, logging, progress tracking. Added index signatures to 4 service types. -245 lines total. Commit: 60af440 |
| **P3** | DUP-005 | Duplication | `src/hooks/useShopPublishing.ts`, `src/hooks/useHeritagePublishing.ts` | 114-234, 56-172 | Publishing hook pattern duplicated. Identical: signer validation, consent dialog, state management, progress tracking, error handling, logging | Create `src/hooks/useContentPublishing.ts` with generic wrapper. Support both Zustand (Shop) and useState (Heritage) via injected state setters | âœ… DONE: Created useContentPublishing.ts (235 lines) with 3 generic params. Refactored both hooks: Shop (420â†’332, -87), Heritage (247â†’168, -80). Extracted signer validation, consent dialog, state management, error handling, logging. publishProductWithAttachments (140â†’14), publishHeritage (150â†’29). Eliminated ~220 lines duplicate logic. Added index signature to HeritagePublishingResult. Commits: 12f7cf6 (SOA fix), 68dd51d |
| **P3** | SOA-004 | SOA Violation | `src/services/business/MediaBusinessService.ts` | 52 | Stateful singleton: `private lifecycleEvents: AttachmentLifecycleEvent[] = []` | Remove state from service. Return events from methods. Let hooks/components manage state with useState | âœ… DONE: Removed lifecycleEvents array, getLifecycleEvents(), clearLifecycleEvents(). Simplified trackLifecycleEvent() to logging only. Service now stateless (-25 lines). Unused methods removed. Commit: 2b826e7 |
| **P3** | ARCH-005 | Architecture | `src/services/nostr/NostrEventService.ts`, `src/services/business/ShopBusinessService.ts` | 19, 567, 602, 681, 21 | Circular dependency: NostrEventService imports ProductAttachment from ShopBusinessService (nostrâ†’business), ShopBusinessService imports from NostrEventService (businessâ†’nostr) | Extract ProductAttachment to shared types. Both services import from types/attachments | âœ… DONE: Moved ProductAttachment from ShopBusinessService to types/attachments.ts. Updated NostrEventService to import from types (replaced 4 dynamic imports). Re-export from ShopBusinessService for backward compatibility. Circular dependency resolved. Build passes. Commit: 53fb6a2 |
| **P4** | ARCH-002 | Architecture | `src/services/business/ShopContentService.ts`, `src/services/business/HeritageContentService.ts` | 144, 686 | Both implement `ContentDetailProvider` with duplicated helper functions: tryGetNpub(), tryGetAuthorDisplayName() | Create `src/services/business/BaseContentProvider.ts` abstract class. Both services extend it | âœ… DONE: Created BaseContentProvider abstract class (58 lines) with shared utilities. ShopContentService and HeritageContentService now extend base class. Eliminated 40+ lines of duplicated code. Both maintain singleton pattern. Abstract getServiceName() method for logging. Build passes. Commit: 8bf3245 |
| **P4** | SOA-005 | SOA Violation | `src/hooks/useNostrSignIn.ts` | 92-94, 154-156 | Navigation logic `router.push('/')` in hook | Return `{ success: boolean }` from signIn methods. Component handles navigation based on result | ðŸ”² TODO |
| **P5** | ARCH-001 | Documentation | `src/services/generic/GenericMediaService.ts`, `src/services/business/MediaBusinessService.ts` | N/A | Two services handle attachments. Unclear boundaries | Add JSDoc: GenericMediaService = storage/validation. MediaBusinessService = business rules/orchestration | ðŸ”² TODO |
| **P5** | DUP-003 | Duplication | `src/hooks/useAttachmentManager.ts`, `src/hooks/useSelectiveAttachmentManager.ts`, `src/hooks/useMultipleAttachments.ts` | 987, 503, 270 lines | Three overlapping attachment implementations. SelectiveAttachmentManager wraps + re-implements useAttachmentManager | Document when to use each OR consolidate into single configurable hook with mode parameter | ðŸ”² TODO |
| **P5** | ARCH-003 | Documentation | `src/services/generic/GenericRelayService.ts`, `src/services/nostr/NostrEventService.ts` | N/A | GenericRelayService (singleton) + NostrEventService (delegates). State consistency risk | Add JSDoc explaining delegation pattern. NostrEventService is facade, GenericRelayService is implementation | ðŸ”² TODO |
| **P5** | ARCH-004 | Documentation | `src/hooks/useGenericAttachmentWorkflow.ts`, `src/hooks/useMultiAttachmentWorkflow.ts` | N/A | Similar state management. Unclear when to use which | Add JSDoc explaining: useGenericAttachmentWorkflow = single content type. useMultiAttachmentWorkflow = multiple types in one form | ðŸ”² TODO |
| **P5** | MIN-003 | Consistency | Multiple hooks | N/A | Inconsistent error handling (Error objects vs strings) | Standardize on AppError throughout. Search/replace string errors with `new AppError(...)` | ðŸ”² TODO |
